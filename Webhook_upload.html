<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <!-- ビューポート設定：スマホでの表示倍率を適正にするために必須 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>PDF分割 & n8n自動アップロード</title>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>

<body>
  <h1>PDF分割 & n8n自動アップロード</h1>
  <p class="sub-title">(1ページずつPOST / 成功時2分待機)</p>
  <p class="description">各ページのアップロードが<strong>成功</strong>した場合のみ、次の送信まで<strong>2分待機</strong>します。<br>失敗時は待機せずに進みます。</p>

  <div class="container">
    <!-- ファイル情報表示エリア（兼クリックエリア） -->
    <div id="fileNameDisplay" class="file-info-box">
      ここにファイルをドラッグ＆ドロップ<br>
      <span style="font-size:0.8em; color:#6366f1; text-decoration:underline;">または ここをタップしてファイル選択</span>
    </div>

    <!-- アクションエリア -->
    <div class="actions">
      <!-- 実態のinputは隠してデザインをスッキリさせることもできますが、今回はわかりやすく表示しつつスタイル調整 -->
      <input type="file" id="pdfFile" accept="application/pdf">
      <button id="splitBtn" disabled>分割 & アップロード開始</button>
    </div>
    
    <div id="result"></div>
  </div>

  <style>
    /* --- 基本設定 --- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* --- コンテナ --- */
    .container {
      width: 100%;
      max-width: 600px; /* PCでも広がりすぎないように */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* --- テキスト要素 --- */
    h1 {
      text-align: center;
      margin: 0 0 10px 0;
      font-size: 1.5rem;
      line-height: 1.3;
    }
    .sub-title {
      margin: 0 0 15px 0;
      font-size: 1rem;
      color: #a5b4fc;
      font-weight: bold;
      text-align: center;
    }
    .description {
      text-align: center;
      font-size: 0.9rem;
      color: #cbd5e1;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    /* --- ファイル名表示ボックス (ドラッグ＆ドロップエリア) --- */
    .file-info-box {
      width: 100%;
      padding: 30px 15px;
      background-color: #1e293b;
      border: 2px dashed #334155; /* 破線にしてドロップエリアっぽく */
      border-radius: 12px;
      text-align: center;
      color: #9ca3af;
      font-size: 0.95rem;
      box-sizing: border-box;
      margin-bottom: 20px;
      cursor: pointer; /* クリックできることを示す */
      transition: all 0.2s;
    }

    .file-info-box:hover, .file-info-box.drag-over {
      border-color: #6366f1;
      background-color: #27304d;
      color: #fff;
    }

    /* --- ボタンと入力欄のグループ --- */
    .actions {
      display: flex;
      flex-direction: column; /* スマホファースト：基本は縦並び */
      gap: 15px;
      width: 100%;
      align-items: center;
    }

    /* ファイル選択ボタン（標準） */
    input[type="file"] {
      font-size: 0.9rem;
      width: 100%;
      max-width: 100%;
      color: #cbd5e1;
    }
    /* ファイル選択ボタンの「ファイルを選択」部分のスタイル調整 */
    input[type="file"]::file-selector-button {
      background-color: #334155;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    /* --- 実行ボタン --- */
    button {
      background: #6366f1;
      color: white;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 15px 0; /* スマホでタップしやすいように高さを確保 */
      width: 100%;     /* 幅いっぱいに */
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s, opacity 0.3s;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      background-color: #4f46e5;
    }
    
    button:disabled {
      background-color: #475569;
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* --- 処理結果エリア --- */
    #result {
      margin-top: 20px;
      width: 100%;
      background: #0f172a;
    }

    .page-link {
      display: block;
      margin: 8px 0;
      color: #a5b4fc;
      text-decoration: none;
      font-size: 0.9rem;
      border-bottom: 1px solid #334155;
      padding-bottom: 4px;
    }

    .log-entry {
      margin: 5px 0;
      font-size: 0.85rem;
      border-left: 3px solid #6366f1;
      padding-left: 8px;
    }

    .muted {
      color: #94a3b8;
      font-style: italic;
      border-left-color: #475569;
    }

    /* --- PC向け調整（画面幅600px以上） --- */
    @media (min-width: 600px) {
      .actions {
        flex-direction: row; /* 横並びに戻す */
        justify-content: space-between;
      }
      input[type="file"] {
        width: auto;
      }
      button {
        width: auto;
        padding: 10px 24px;
        min-width: 200px;
      }
    }
  </style>

  <script>
    const fileInput = document.getElementById('pdfFile');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const splitBtn = document.getElementById('splitBtn');

    // --- ファイル選択・表示関連の処理 ---
    
    // 表示ボックスをクリックしたらファイル選択ダイアログを開く
    fileNameDisplay.addEventListener('click', () => {
      fileInput.click();
    });

    const updateFileDisplay = () => {
      if (fileInput.files.length > 0) {
        const fileName = fileInput.files[0].name;
        fileNameDisplay.innerHTML = `<strong>選択中:</strong> ${fileName}<br><span style="font-size:0.8em; color:#4ade80;">アップロード準備完了</span>`;
        fileNameDisplay.style.borderColor = '#4ade80';
        fileNameDisplay.style.color = '#e5e7eb';
        splitBtn.disabled = false;
      } else {
        fileNameDisplay.innerHTML = `ここにファイルをドラッグ＆ドロップ<br><span style="font-size:0.8em; color:#6366f1; text-decoration:underline;">または ここをタップしてファイル選択</span>`;
        fileNameDisplay.style.borderColor = '#334155';
        fileNameDisplay.style.color = '#9ca3af';
        splitBtn.disabled = true;
      }
    };

    // ファイルインプット変更時
    fileInput.addEventListener('change', updateFileDisplay);

    // --- ユーティリティ関数 ---
    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
    
    const upload = (url, formData) => new Promise((resolve) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.timeout = 60000; // 60秒タイムアウト
      xhr.onload = () => resolve(xhr.status >= 200 && xhr.status < 300);
      xhr.onerror = () => resolve(false);
      xhr.ontimeout = () => resolve(false);
      xhr.send(formData);
    });

    // --- メイン処理 ---
    splitBtn.addEventListener('click', async () => {
      const resultDiv = document.getElementById('result');
      
      if (!fileInput.files.length) { 
        alert('PDFファイルを選択してください'); 
        return; 
      }
      
      // UIロック
      splitBtn.disabled = true;
      splitBtn.textContent = "処理中...";
      fileInput.disabled = true;
      fileNameDisplay.style.pointerEvents = "none"; // クリック無効化
      resultDiv.innerHTML = '';

      try {
        const file = fileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const totalPages = pdfDoc.getPageCount();
        
        // ★ n8nのWebhook URL
        const webhookUrl = 'http://localhost:5678/webhook-test/261d8002-88b3-44dc-bbf1-4ca7ff3025a6';
        
        resultDiv.innerHTML = `<div style="margin-bottom:15px; font-weight:bold;">PDFページ数: ${totalPages}</div>`;

        for (let i = 0; i < totalPages; i++) {
          // 1ページずつ抽出
          const newPdf = await PDFLib.PDFDocument.create();
          const [copiedPage] = await newPdf.copyPages(pdfDoc, [i]);
          newPdf.addPage(copiedPage);
          const pdfBytes = await newPdf.save();
          
          const blob = new Blob([pdfBytes], { type: 'application/pdf' });
          const pageNum = i + 1;
          
          // ダウンロードリンク生成
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.textContent = `ページ ${pageNum} をダウンロード`;
          a.download = `page_${pageNum}.pdf`;
          a.className = 'page-link';
          // クリック後メモリ解放
          a.addEventListener('click', () => setTimeout(() => URL.revokeObjectURL(url), 0));
          resultDiv.appendChild(a);

          // POSTデータ作成
          const formData = new FormData();
          formData.append('file', blob, `page_${pageNum}.pdf`);
          formData.append('title', `page_${pageNum}.pdf`);
          formData.append('mimeType', 'application/pdf');

          // ログ出力
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry';
          logEntry.textContent = `[${pageNum}/${totalPages}] アップロード中…`;
          resultDiv.appendChild(logEntry);

          // 自動スクロール
          logEntry.scrollIntoView({ behavior: 'smooth', block: 'end' });

          // アップロード実行
          const ok = await upload(webhookUrl, formData);

          if (ok) {
            logEntry.textContent = `[${pageNum}/${totalPages}] アップロード完了 (成功)`;
            logEntry.style.color = "#4ade80"; // 緑色

            // 最後のページでなければ待機
            if (i < totalPages - 1) {
              const waitMsg = document.createElement('div');
              waitMsg.className = 'log-entry muted';
              waitMsg.textContent = `⏳ 成功したため、次の送信まで2分待機します…`;
              resultDiv.appendChild(waitMsg);
              
              // 待機処理
              await sleep(120000); // 2分
              
              waitMsg.textContent = `✅ 2分経過。次のページ（${pageNum + 1}）へ進みます。`;
            }
          } else {
            logEntry.textContent = `[${pageNum}/${totalPages}] ❌ アップロード失敗 (待機せず次へ)`;
            logEntry.style.color = "#f87171"; // 赤色
          }
        }
        
        // 全完了
        const doneMsg = document.createElement('div');
        doneMsg.textContent = "すべての処理が完了しました。";
        doneMsg.style.marginTop = "20px";
        doneMsg.style.fontWeight = "bold";
        doneMsg.style.color = "#fff";
        resultDiv.appendChild(doneMsg);

      } catch (e) {
        console.error(e);
        alert('処理中にエラーが発生しました: ' + e.message);
      } finally {
        // ロック解除
        splitBtn.textContent = "分割 & アップロード";
        splitBtn.disabled = false;
        fileInput.disabled = false;
        fileNameDisplay.style.pointerEvents = "auto";
      }
    });

    // --- ドラッグ＆ドロップ処理 ---
    const preventDefaults = (e) => {
      e.preventDefault();
      e.stopPropagation();
    };

    const highlight = () => fileNameDisplay.classList.add('drag-over');
    const unhighlight = () => fileNameDisplay.classList.remove('drag-over');

    const handleDrop = (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      updateFileDisplay(); // 表示更新関数を呼ぶ
    };

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
      fileNameDisplay.addEventListener(eventName, highlight, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      fileNameDisplay.addEventListener(eventName, unhighlight, false);
    });

    fileNameDisplay.addEventListener('drop', handleDrop, false);
  </script>
</body>
</html>
