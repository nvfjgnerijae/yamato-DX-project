
<!--検索機能の追加-->

<!--GASのコード-->
<!--
function doGet() {
  // HTMLファイル名が "index" の場合
  return HtmlService.createTemplateFromFile('index').evaluate()
      .setTitle('流動票アプリ')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function doGet() {
  // HTMLファイル名が "index" の場合
  return HtmlService.createTemplateFromFile('index').evaluate()
      .setTitle('流動票アプリ')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function doGet() {
  return HtmlService.createTemplateFromFile('index').evaluate()
      .setTitle('流動票アプリ')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

// 壊れている可能性のあるJSON（{...}{...}など）を配列として復元する補助関数
function parseRobust(text) {
  if (!text || text.trim() === "") return [];
  const results = [];
  let buf = '';
  let depth = 0;
  let inString = false;
  let prev = '';

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"' && prev !== '\\') inString = !inString;
    
    if (!inString) {
      if (ch === '{') {
        if (depth === 0) buf = '';
        depth++;
      }
    }
    
    if (depth > 0) buf += ch;

    if (!inString) {
      if (ch === '}') {
        depth--;
        if (depth === 0) {
          try {
            results.push(JSON.parse(buf));
          } catch (e) {}
          buf = '';
        }
      }
    }
    prev = ch;
  }
  return results;
}

// ドライブからテキストデータを取得する関数
function getDataFromDrive() {
  // 初期状態では空文字を返すことで、画面への反映を防ぐ
  return "";
}

// データを保存・更新する関数
function saveDataToDrive(jsonText) {
  const FILE_ID = '17bTFuAhrij79UPMJ1YkyktBITGVbG5ze'; 
  const file = DriveApp.getFileById(FILE_ID);
  
  // 1. 既存データの読み込み
  let existingData = [];
  try {
    const text = file.getBlob().getDataAsString();
    // parseRobustで抽出後、IDごとに結合して完全なレコード配列に戻す
    const rawObjects = parseRobust(text);
    existingData = mergeSplitObjects(rawObjects);
  } catch (e) {
    existingData = [];
  }

  // 2. 送信されたデータの処理
  let newRecord = {};
  try {
    const inputParts = parseRobust(jsonText);
    newRecord = Object.assign({}, ...inputParts);
  } catch (e) {
    throw new Error("送信データの形式が不正です。");
  }

  // 3. ID（流動票番号）による更新判定
  const newId = newRecord["基本情報"] ? newRecord["基本情報"]["流動票番号"] : null;
  
  if (!newId) {
    existingData.push(newRecord);
  } else {
    let isUpdated = false;
    for (let i = 0; i < existingData.length; i++) {
      const currentId = existingData[i]["基本情報"] ? existingData[i]["基本情報"]["流動票番号"] : null;
      if (currentId === newId) {
        existingData[i] = newRecord; // 上書き更新
        isUpdated = true;
        break;
      }
    }
    if (!isUpdated) {
      existingData.push(newRecord);
    }
  }

  // 4. 指定されたMarkdown形式（```json ... ```）に変換して保存
  try {
    const formattedText = existingData.map(record => formatRecordToMarkdown(record)).join("\n\n");
    file.setContent(formattedText); 
    return "Driveへの保存・更新が完了しました。";
  } catch (e) {
    throw new Error("Driveへの書き込みに失敗しました: " + e.message);
  }
}

// 流動票番号でデータを検索する関数
function searchByNumber(targetNumber) {
  const FILE_ID = '17bTFuAhrij79UPMJ1YkyktBITGVbG5ze'; 
  
  try {
    const file = DriveApp.getFileById(FILE_ID);
    const text = file.getBlob().getDataAsString();
    
    // 読み込みとマージを行う
    const rawObjects = parseRobust(text);
    const dataList = mergeSplitObjects(rawObjects);
    
    const targetStr = String(targetNumber).trim();
    const foundItems = [];

    // 検索
    dataList.forEach(item => {
      let id = null;
      if (item["基本情報"] && item["基本情報"]["流動票番号"]) {
        id = item["基本情報"]["流動票番号"];
      } else if (item["工程管理記入欄"] && item["工程管理記入欄"]["流動票番号"]) {
        id = item["工程管理記入欄"]["流動票番号"];
      }
      
      if (id && String(id).trim() === targetStr) {
        foundItems.push(item);
      }
    });

    if (foundItems.length > 0) {
      // フロントエンド用にMarkdown形式に整形して返す
      return foundItems.map(item => formatRecordToMarkdown(item)).join("\n\n");
    } else {
      return null;
    }
  } catch (e) {
    throw new Error("検索中にエラー: " + e.message);
  }
}

// レコードデータを指定されたMarkdown形式の文字列に変換する補助関数
function formatRecordToMarkdown(record) {
  // 1つ目のブロック: 基本情報、管理部門記入欄
  const part1 = {};
  if (record["基本情報"]) part1["基本情報"] = record["基本情報"];
  if (record["管理部門記入欄"]) part1["管理部門記入欄"] = record["管理部門記入欄"];

  // 2つ目のブロック: 工程管理記入欄、調査項目
  const part2 = {};
  if (record["工程管理記入欄"]) part2["工程管理記入欄"] = record["工程管理記入欄"];
  if (record["調査項目"]) part2["調査項目"] = record["調査項目"];

  // ```json で囲んで出力
  return "```json\n" + JSON.stringify(part1, null, 2) + "\n```\n" +
         "```json\n" + JSON.stringify(part2, null, 2) + "\n```";
}

// バラバラに読み込まれたJSONブロックを、流動票番号をキーにして1つのオブジェクトに統合する関数
function mergeSplitObjects(objects) {
  const mergedMap = new Map();
  const resultOrder = []; // データの並び順を保持用

  objects.forEach(obj => {
    // 流動票番号を探す
    let id = null;
    if (obj["基本情報"] && obj["基本情報"]["流動票番号"]) {
      id = obj["基本情報"]["流動票番号"];
    } else if (obj["工程管理記入欄"] && obj["工程管理記入欄"]["流動票番号"]) {
      id = obj["工程管理記入欄"]["流動票番号"];
    }

    if (id) {
      if (!mergedMap.has(id)) {
        const newRecord = {};
        mergedMap.set(id, newRecord);
        resultOrder.push(newRecord);
      }
      // 既存のオブジェクトにプロパティをマージ
      Object.assign(mergedMap.get(id), obj);
    }
  });

  return resultOrder;
}
-->

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link type="text/css" rel="stylesheet" href="resources/sheet.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
/* ========================================
   流動票 スリム化CSS
   ======================================== */
.ritz .waffle a { color: inherit; }

/* ベーススタイル（全セル共通） */
.ritz .waffle td {
  background-color: #fff;
  color: #000;
  font-family: Arial;
  font-size: 8pt;
  vertical-align: middle;
  white-space: nowrap;
  direction: ltr;
  padding: 0 3px;
}

/* text-align バリエーション */
.ritz .waffle .s0,.ritz .waffle .s5,.ritz .waffle .s7,.ritz .waffle .s8,.ritz .waffle .s9,.ritz .waffle .s10,
.ritz .waffle .s11,.ritz .waffle .s13,.ritz .waffle .s16,.ritz .waffle .s17,.ritz .waffle .s18,.ritz .waffle .s19,
.ritz .waffle .s21,.ritz .waffle .s22,.ritz .waffle .s25,.ritz .waffle .s28,.ritz .waffle .s31,.ritz .waffle .s32,
.ritz .waffle .s33,.ritz .waffle .s36,.ritz .waffle .s43,.ritz .waffle .s44,.ritz .waffle .s45,
.ritz .waffle .s46,.ritz .waffle .s48,.ritz .waffle .s49,.ritz .waffle .s52,.ritz .waffle .s53,.ritz .waffle .s54,
.ritz .waffle .s55,.ritz .waffle .s56,.ritz .waffle .s57,
.ritz .waffle .s58 {
  text-align: center;
}

.ritz .waffle .s1,.ritz .waffle .s4,.ritz .waffle .s6,.ritz .waffle .s12,.ritz .waffle .s14,.ritz .waffle .s15,
.ritz .waffle .s20,.ritz .waffle .s23,.ritz .waffle .s24,.ritz .waffle .s26,.ritz .waffle .s29,.ritz .waffle .s30,
.ritz .waffle .s35,.ritz .waffle .s37,.ritz .waffle .s38,.ritz .waffle .s39,.ritz .waffle .s40,.ritz .waffle .s42,
.ritz .waffle .s47,.ritz .waffle .s50,.ritz .waffle .s51 {
  text-align: left;
}

.ritz .waffle .s3,.ritz .waffle .s19 {
  text-align: right;
}

/* border パターン - 下線2px */
.ritz .waffle .s4,.ritz .waffle .s5,.ritz .waffle .s6,.ritz .waffle .s7,.ritz .waffle .s24,.ritz .waffle .s25,
.ritz .waffle .s26,.ritz .waffle .s30,.ritz .waffle .s33,.ritz .waffle .s46,.ritz .waffle .s47,.ritz .waffle .s48,
.ritz .waffle .s49,.ritz .waffle .s50,.ritz .waffle .s51,.ritz .waffle .s52,.ritz .waffle .s53,.ritz .waffle .s54,
.ritz .waffle .s57 {
  border-bottom: 2px solid #000;
}

/* 下線1px */
.ritz .waffle .s10,.ritz .waffle .s11,.ritz .waffle .s12,.ritz .waffle .s13,.ritz .waffle .s14,.ritz .waffle .s15,
.ritz .waffle .s16,.ritz .waffle .s17,.ritz .waffle .s18,.ritz .waffle .s19,.ritz .waffle .s20,.ritz .waffle .s21,
.ritz .waffle .s22,.ritz .waffle .s23,.ritz .waffle .s28,.ritz .waffle .s31,.ritz .waffle .s32,.ritz .waffle .s34,
.ritz .waffle .s35,.ritz .waffle .s40,.ritz .waffle .s41,.ritz .waffle .s42,.ritz .waffle .s56,.ritz .waffle .s58 {
  border-bottom: 1px solid #000;
}

/* 右線2px */
.ritz .waffle .s8,.ritz .waffle .s11,.ritz .waffle .s13,.ritz .waffle .s14,.ritz .waffle .s21,.ritz .waffle .s26,
.ritz .waffle .s27,.ritz .waffle .s34,.ritz .waffle .s39,.ritz .waffle .s42,.ritz .waffle .s45,.ritz .waffle .s53,
.ritz .waffle .s54,.ritz .waffle .s58 {
  border-right: 2px solid #000;
}

/* 右線1px */
.ritz .waffle .s9,.ritz .waffle .s10,.ritz .waffle .s12,.ritz .waffle .s15,.ritz .waffle .s16,.ritz .waffle .s17,
.ritz .waffle .s18,.ritz .waffle .s19,.ritz .waffle .s20,.ritz .waffle .s22,.ritz .waffle .s23,.ritz .waffle .s24,
.ritz .waffle .s25,.ritz .waffle .s28,.ritz .waffle .s31,.ritz .waffle .s32,.ritz .waffle .s33,.ritz .waffle .s35,
.ritz .waffle .s43,.ritz .waffle .s44,.ritz .waffle .s46,.ritz .waffle .s47,.ritz .waffle .s48,.ritz .waffle .s50,
.ritz .waffle .s51,.ritz .waffle .s52,.ritz .waffle .s55,.ritz .waffle .s56,.ritz .waffle .s57 {
  border-right: 1px solid #000;
}

/* 背景色グレー */
.ritz .waffle .s13,.ritz .waffle .s15,.ritz .waffle .s22,.ritz .waffle .s26,.ritz .waffle .s55 {
  background-color: #d9d9d9;
}

/* font-size バリエーション */
.ritz .waffle .s2 {
  font-size: 22pt;
  font-weight: 700;
}

.ritz .waffle .s7,.ritz .waffle .s21,.ritz .waffle .s25,.ritz .waffle .s32 {
  font-size: 9pt;
}

.ritz .waffle .s17,.ritz .waffle .s44,.ritz .waffle .s45,.ritz .waffle .s48 {
  font-size: 10pt;
}

.ritz .waffle .s28,.ritz .waffle .s35,.ritz .waffle .s36,.ritz .waffle .s37,.ritz .waffle .s38,.ritz .waffle .s39,
.ritz .waffle .s40,.ritz .waffle .s42,.ritz .waffle .s46,.ritz .waffle .s47,.ritz .waffle .s50,.ritz .waffle .s51 {
  font-size: 11pt;
}

.ritz .waffle .s52,.ritz .waffle .s53 {
  font-size: 14pt;
}

.ritz .waffle .s18,.ritz .waffle .s31,.ritz .waffle .s56,.ritz .waffle .s57,.ritz .waffle .s58 {
  font-size: 7pt;
}

.ritz .waffle .s29,.ritz .waffle .s30 {
  font-size: 10pt;
}

/* font-weight: bold */
.ritz .waffle .s2,.ritz .waffle .s7,.ritz .waffle .s17,.ritz .waffle .s21,.ritz .waffle .s25,.ritz .waffle .s38,
.ritz .waffle .s52,.ritz .waffle .s53 {
  font-weight: 700;
}

/* font-family 特殊 */
.ritz .waffle .s15,.ritz .waffle .s23,.ritz .waffle .s37,.ritz .waffle .s39,.ritz .waffle .s42 {
  font-family: "docs-Aptos Narrow", Arial;
}

/* 折り返し許可 */
.ritz .waffle .s16,.ritz .waffle .s17,.ritz .waffle .s18,.ritz .waffle .s20,.ritz .waffle .s21 {
  white-space: normal;
  overflow: hidden;
  word-wrap: break-word;
}

/* 縦書きセル */
.ritz .waffle .s9 {
  line-height: 1.4;
  padding: 2px 3px;
  border-bottom: 2px solid #000; /* ← この行を追加 */
}

/* 特殊クラス */
.ritz .waffle .s27 {
  background-color: #fff;
}

.ritz .waffle .s41 {
  border-bottom: 1px solid #000;
  background-color: #fff;
}

.ritz .waffle .s59 {
  width: 0;
  padding: 0;
  margin: 0;
  overflow: hidden;
}

/* 入力セル */
td[contenteditable="true"] { outline: none; }
td[contenteditable="true"]:focus { box-shadow: inset 0 0 0 1px #4c9aff; }

/* ヘッダー行 */
thead, th.row-headers-background {
  display: table-header-group;
  height: 0;
  line-height: 0;
  font-size: 0;
  overflow: hidden;
  visibility: hidden;
}

/* テーブルレイアウト */
.ritz .waffle { table-layout: fixed; }
.ritz .waffle td { overflow: hidden; text-overflow: ellipsis; }
.ritz .waffle td.wrap-cell {
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: clip !important;
  word-break: break-all;
}

/* 印刷用 */
@media print {
  #control-panel { display: none; }
  body { margin: 0; }
  .waffle { zoom: 1.00; }
  html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .ritz .waffle .s13,
  .ritz .waffle .s15,
  .ritz .waffle .s22,
  .ritz .waffle .s26,
  .ritz .waffle .s55 {
    background-color: #d9d9d9 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}
</style>
<div id="control-panel" style="margin-bottom: 1rem;">
  <!-- ▼▼▼ 検索エリア追加 ▼▼▼ -->
  <div style="margin-bottom: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
    <span style="font-weight:bold;">流動票検索:</span>
    <input type="text" id="search-keyword" placeholder="流動票番号を入力" style="font-size: 16px; padding: 4px; width: 150px;">
    <button id="search-btn" style="cursor: pointer; padding: 4px 12px;">検索して反映</button>
    <span id="search-status" style="font-size: 12px; color: #666;"></span>
  </div>
  <!-- ▲▲▲ 検索エリア追加 ▲▲▲ -->

  <textarea id="json-input" rows="10" style="width:100%;"
  placeholder=
'```json
{
  "基本情報":
}
```
```json
{
  "工程管理記入欄": 
}
```
  '></textarea>
  <div style="margin-top: 0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap; align-items: center;">
  <button id="apply-json-btn">情報を反映</button>
  <button id="print-btn">印刷/PDF</button>
  <button id="save-btn">ドライブに保存</button>
  <!-- 保存状況を表示する場所 -->
  <span id="save-status" style="font-size: 0.8rem; color: #666; margin-left: 10px;"></span>
</div>
</div>
<div class="ritz grid-container" dir="ltr">
<table class="waffle" cellspacing="0" cellpadding="0">
<thead>
<tr>
<th class="row-header freezebar-origin-ltr"></th>
<th id="942883767C0" style="width:0px" class="column-headers-background">A</th>
<th id="942883767C1" style="width:34px" class="column-headers-background">B</th>
<th id="942883767C2" style="width:28px" class="column-headers-background">C</th>
<th id="942883767C3" style="width:29px" class="column-headers-background">D</th>
<th id="942883767C4" style="width:34px" class="column-headers-background">E</th>
<th id="942883767C5" style="width:36px" class="column-headers-background">F</th>
<th id="942883767C6" style="width:21px" class="column-headers-background">G</th>
<th id="942883767C7" style="width:6px" class="column-headers-background">H</th>
<th id="942883767C8" style="width:36px" class="column-headers-background">I</th>
<th id="942883767C9" style="width:30px" class="column-headers-background">J</th>
<th id="942883767C10" style="width:47px" class="column-headers-background">K</th>
<th id="942883767C11" style="width:24px" class="column-headers-background">L</th>
<th id="942883767C12" style="width:33px" class="column-headers-background">M</th>
<th id="942883767C13" style="width:45px" class="column-headers-background">N</th>
<th id="942883767C14" style="width:21px" class="column-headers-background">O</th>
<th id="942883767C15" style="width:45px" class="column-headers-background">P</th>
<th id="942883767C16" style="width:76px" class="column-headers-background">Q</th>
<th id="942883767C17" style="width:61px" class="column-headers-background">R</th>
<th id="942883767C18" style="width:39px" class="column-headers-background">S</th>
<th id="942883767C19" style="width:46px" class="column-headers-background">T</th>
</tr>
</thead>
<tbody>
<tr style="height:23px">
<th id="942883767R0" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">1</div></th>
<td class="s60"></td>
<td class="s60" dir="ltr"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
<td class="s60"></td>
</tr>
<tr style="height:23px">
<th id="942883767R1" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">2</div></th>
<td class="s0"></td>
<td class="s1" colspan="2">様式-1</td>
<td class="s1"></td>
<td class="s1"></td>
<td class="s1"></td>
<td class="s1"></td>
<td class="s1"></td>
<td class="s2" dir="ltr"></td>
<td class="s2" dir="ltr" colspan="5" rowspan="2">流　動　票</td>
<td class="s2"></td>
<td class="s2"></td>
<td class="s3" colspan="2">大和電機工業株式会社</td>
</tr>
<tr style="height:23px">
<th id="942883767R2" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">3</div></th>
<td class="s1"></td>
<td class="s1">発行日</td>
<td class="s1" dir="ltr" colspan="3"></td>
<td class="s1"></td>
<td class="s1"></td>
<td class="s1"></td>
<td class="s2" dir="ltr"></td>
<td class="s2"></td>
<td class="s2"></td>
<td class="s2"></td>
<td class="s3">特機事業所</td>
</tr>
<tr style="height:23px">
<th id="942883767R3" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">4</div></th>
<td class="s1"></td>
<td class="s4" dir="ltr">Rev.H</td>
<td class="s4"></td>
<td class="s4"></td>
<td class="s4"></td>
<td class="s4"></td>
<td class="s4" colspan="3">依頼主</td>
<td class="s5" colspan="5"></td>
<td class="s5"></td>
<td class="s6" dir="ltr">No.</td>
<td class="s7" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R4" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">5</div></th>
<td class="s8"></td>
<td class="s9" rowspan="16">管<br>理<br>部<br>門<br>記<br>入<br>欄</td>
<td class="s10" colspan="6">会社名</td>
<td class="s10" dir="ltr" colspan="6">製品名</td>
<td class="s10" dir="ltr" colspan="3">図面番号</td>
<td class="s11">発送日</td>
</tr>
<tr style="height:23px">
<th id="942883767R5" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">6</div></th>
<td class="s8"></td>
<td class="s12" dir="ltr" colspan="6"></td>
<td class="s12" dir="ltr" colspan="6"></td>
<td class="s12" dir="ltr" colspan="3"></td>
<td class="s11" dir="ltr"></td>
</tr>
<tr style="height:23px">
<th id="942883767R6" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">7</div></th>
<td class="s8"></td>
<td class="s10" dir="ltr" colspan="2">分納納期１</td>
<td class="s10" dir="ltr" colspan="2"></td>
<td class="s10" dir="ltr" colspan="3"></td>
<td class="s10" dir="ltr" colspan="2">分納納期２</td>
<td class="s10" dir="ltr" colspan="2"></td>
<td class="s10" dir="ltr" colspan="2"></td>
<td class="s13" dir="ltr" colspan="3"></td>
</tr>
<tr style="height:23px">
<th id="942883767R7" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">8</div></th>
<td class="s8"></td>
<td class="s10" colspan="2">材質</td>
<td class="s12" dir="ltr" colspan="6"></td>
<td class="s10">フライス</td>
<td class="s12" dir="ltr" colspan="2"></td>
<td class="s10" colspan="2">購入先</td>
<td class="s14" dir="ltr" colspan="3"></td>
</tr>
<tr style="height:23px">
<th id="942883767R8" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">9</div></th>
<td class="s8"></td>
<td class="s10" colspan="2">材料寸法</td>
<td class="s10">縦</td>
<td class="s10" dir="ltr" colspan="3"></td>
<td class="s10">横</td>
<td class="s10" dir="ltr" colspan="2"></td>
<td class="s10">高</td>
<td class="s10" dir="ltr" colspan="3"></td>
<td class="s10" colspan="1">個数</td>
<td class="s10" dir="ltr">材料価格</td>
<td class="s14" dir="ltr"></td>
</tr>
<tr style="height:23px">
<th id="942883767R9" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">10</div></th>
<td class="s8"></td>
<td class="s16" dir="ltr" colspan="3">新規/リピート</td>
<td class="s17" dir="ltr" colspan="4"></td>
<td class="s18" dir="ltr" colspan="2">製造/設計/転売</td>
<td class="s17" dir="ltr" colspan="2"></td>
<td class="s55" dir="ltr" colspan="2" rowspan="3"></td>
<td class="s19" dir="ltr" colspan="1"></td>
<td class="s10" dir="ltr">外注価格</td>
<td class="s14" dir="ltr"></td>
</tr>
<tr style="height:23px">
<th id="942883767R10" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">11</div></th>
<td class="s8"></td>
<td class="s10" colspan="2">業者1</td>
<td class="s20" dir="ltr" colspan="5"></td>
<td class="s18">役割</td>
<td class="s20" dir="ltr" colspan="3"></td>
<td class="s10" dir="ltr" colspan="1">注文数</td>
<td class="s10" dir="ltr">販売単価</td>
<td class="s14" dir="ltr"></td>
</tr>
<tr style="height:23px">
<th id="942883767R11" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">12</div></th>
<td class="s8"></td>
<td class="s10" colspan="2">業者2</td>
<td class="s20" dir="ltr" colspan="5"></td>
<td class="s18">役割</td>
<td class="s20" dir="ltr" colspan="3"></td>
<td class="s19" colspan="1"></td>
<td class="s10" dir="ltr" rowspan="2">作成者</td>
<td class="s21" dir="ltr" rowspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R12" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">13</div></th>
<td class="s8"></td>
<td class="s10" colspan="2">業者3</td>
<td class="s20" dir="ltr" colspan="5"></td>
<td class="s18">役割</td>
<td class="s20" dir="ltr" colspan="3"></td>
<td class="s22" colspan="3" rowspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R13" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">14</div></th>
<td class="s8"></td>
<td class="s10" colspan="2">業者4</td>
<td class="s20" colspan="5"></td>
<td class="s18">役割</td>
<td class="s20" colspan="3"></td>
<td class="s13" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R14" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">15</div></th>
<td class="s8"></td>
<td class="s11" colspan="16">工程の注意点</td>
</tr>
<tr style="height:23px">
<th id="942883767R15" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">16</div></th>
<td class="s8"></td>
<td class="s14" dir="ltr" colspan="16" rowspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R16" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">17</div></th>
<td class="s8"></td>
</tr>
<tr style="height:23px">
<th id="942883767R17" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">18</div></th>
<td class="s8"></td>
<td class="s10" colspan="4">図面問い合わせ内容：</td>
<td class="s14" colspan="12"></td>
</tr>
<tr style="height:23px">
<th id="942883767R18" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">19</div></th>
<td class="s8"></td>
<td class="s10" colspan="4">回答：</td>
<td class="s14" colspan="12"></td>
</tr>
<tr style="height:23px">
<th id="942883767R19" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">20</div></th>
<td class="s8"></td>
<td class="s24" dir="ltr"colspan="2">処理の有無</td>
<td class="s25" dir="ltr"></td>
<td class="s24" dir="ltr">台待ち</td>
<td class="s33" dir="ltr" colspan="2"></td>
<td class="s33" dir="ltr">いつ</td>
<td class="s33" dir="ltr" colspan="2"></td>
<td class="s33" dir="ltr">誰が</td>
<td class="s24" dir="ltr" colspan="2"></td>
<td class="s33" dir="ltr" colspan="2">誰に確認</td>
<td class="s24" dir="ltr"></td>
<td class="s26" dir="ltr"></td>
</tr>
<tr style="height:23px">
<th id="942883767R20" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">21</div></th>
<td class="s27"></td>
<td class="s9" rowspan="17">工<br>程<br>管<br>理<br>記<br>入<br>欄</td>
<td class="s28" colspan="5" rowspan="2">特別購入品</td>
<td class="s12" dir="ltr" colspan="7"></td>
<td class="s14" dir="ltr" colspan="4"></td>
</tr>
<tr style="height:23px">
<th id="942883767R21" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">22</div></th>
<td class="s27"></td>
<td class="s12" dir="ltr" colspan="7"></td>
<td class="s14" dir="ltr" colspan="4"></td>
<td class="s30"></td>
<td class="s30"></td>
</tr>
<tr style="height:23px">
<th id="942883767R22" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">23</div></th>
<td class="s27"></td>
<td class="s10">月</td>
<td class="s10" dir="ltr">日</td>
<td class="s10" colspan="3">工程記入</td>
<td class="s10" colspan="3">作業時間</td>
<td class="s10" colspan="2">段取時間(分)</td>
<td class="s10" colspan="2">冶工具</td>
<td class="s10" colspan="2">作業時間(分)</td>
<td class="s31" dir="ltr">外注又は加工者名</td>
<td class="s10">単価</td>
<td class="s11" colspan="2">品質確認者</td>
</tr>
<tr style="height:23px">
<th id="942883767R23" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">24</div></th>
<td class="s27"></td>
<td class="s32" dir="ltr"></td>
<td class="s32" dir="ltr"></td>
<td class="s56" dir="ltr" colspan="3"></td>
<td class="s10" dir="ltr" colspan="3"></td>
<td class="s10" dir="ltr" colspan="2"></td>
<td class="s56" dir="ltr" colspan="2"></td>
<td class="s10" dir="ltr" colspan="2"></td>
<td class="s56" dir="ltr"></td>
<td class="s10" dir="ltr"></td>
<td class="s58" dir="ltr" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R24" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">25</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" dir="ltr" colspan="3"></td>
<td class="s10" dir="ltr" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R25" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">26</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R26" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">27</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R27" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">28</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R28" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">29</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R29" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">30</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R30" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">31</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R31" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">32</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R32" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">33</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R33" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">34</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R34" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">35</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R35" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">36</div></th>
<td class="s27"></td>
<td class="s32"></td>
<td class="s32"></td>
<td class="s56" colspan="3"></td>
<td class="s10" colspan="3"></td>
<td class="s10" colspan="2"></td>
<td class="s56" colspan="2"></td>
<td class="s10" colspan="2"></td>
<td class="s56"></td>
<td class="s10"></td>
<td class="s58" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R36" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">37</div></th>
<td class="s27"></td>
<td class="s33"></td>
<td class="s33"></td>
<td class="s57" colspan="3"></td>
<td class="s33" colspan="3"></td>
<td class="s33" colspan="2"></td>
<td class="s57" colspan="2"></td>
<td class="s33" colspan="2"></td>
<td class="s57"></td>
<td class="s33"></td>
<td class="s54" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R37" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">38</div></th>
<td class="s27"></td>
<td class="s35"></td>
<td class="s28" colspan="4">項　目</td>
<td class="s28" colspan="3">〇　<span style="font-size:11pt;font-family:'Segoe UI Symbol',Arial;color:#000">✕</span></td>
<td class="s36"></td>
<td class="s37"></td>
<td class="s37"></td>
<td class="s38"></td>
<td class="s38"></td>
<td class="s37"></td>
<td class="s37"></td>
<td class="s37"></td>
<td class="s37"></td>
<td class="s37"></td>
<td class="s39"></td>
</tr>
<tr style="height:23px">
<th id="942883767R38" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">39</div></th>
<td class="s27"></td>
<td class="s28">1</td>
<td class="s35" colspan="4">外見確認</td>
<td class="s28" dir="ltr" colspan="3"></td>
<td class="s36" dir="ltr"></td>
<td></td>
<td></td>
<td class="s40"></td>
<td class="s40"></td>
<td></td>
<td></td>
<td class="s41"></td>
<td class="s41"></td>
<td class="s41"></td>
<td class="s42"></td>
</tr>
<tr style="height:23px">
<th id="942883767R39" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">40</div></th>
<td class="s27"></td>
<td class="s28">2</td>
<td class="s35" colspan="4">寸法測定</td>
<td class="s28" dir="ltr" colspan="3"></td>
<td class="s36" dir="ltr"></td>
<td></td>
<td class="s43"></td>
<td class="s10" colspan="2">最終検査員</td>
<td></td>
<td class="s43"></td>
<td class="s10">出荷検査</td>
<td class="s10">出荷承認</td>
<td class="s11" colspan="2">出荷者</td>
</tr>
<tr style="height:23px">
<th id="942883767R40" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">41</div></th>
<td class="s27"></td>
<td class="s28">3</td>
<td class="s35" colspan="4">幾何公差測定</td>
<td class="s28" colspan="3"></td>
<td class="s36"></td>
<td></td>
<td class="s43"></td>
<td class="s44" colspan="2"></td>
<td></td>
<td class="s43"></td>
<td class="s44"></td>
<td class="s44"></td>
<td class="s45" colspan="2"></td>
</tr>
<tr style="height:23px">
<th id="942883767R41" style="height:23px" class="row-headers-background"><div class="row-header-wrapper" style="line-height:23px">42</div></th>
<td class="s27"></td>
<td class="s46">4</td>
<td class="s47" dir="ltr" colspan="4">ミルシートと照合</td>
<td class="s48" dir="ltr" colspan="3"></td>
<td class="s49"></td>
<td class="s49"></td>
<td class="s51"></td>
<td class="s52" dir="ltr" colspan="2"></td>
<td class="s49"></td>
<td class="s51"></td>
<td class="s52"></td>
<td class="s52" dir="ltr"></td>
<td class="s53" colspan="2"></td>
</tr>
</tbody>
</table>
</div>
<script>
// ========== 第1 IIFE: ラベルセルのreadonly化 ==========
(function(){
  const tbody = document.querySelector('.waffle tbody');
  if(!tbody) return;

  const tds = tbody.querySelectorAll('td');
  tds.forEach(td => {
    td.setAttribute('contenteditable','true');
    td.removeAttribute('aria-readonly');
  });

  const LABEL_SET = new Set([
    '様式-1','流動票','流　動　票','大和電機工業株式会社','発行日','特機事業所','Rev.H','依頼主','No.',
    '管理部門記入欄','会社名','製品名','図面番号','発送日','分納納期1','分納納期１','分納納期2','分納納期２',
    '材質','フライス','購入先','材料寸法','縦','横','高','個数','材料価格','新規/リピート','製造/設計/転売','外注価格',
    '業者1','業者２','業者2','業者3','業者4','役割','注文数','販売単価','作成者',
    '工程の注意点','図面問い合わせ内容：','図面問い合わせ内容','回答：','回答',
    '処理の有無','台待ち','いつ','誰が','誰に確認',
    '工程管理記入欄','特別購入品','月','日','工程記入','作業時間','段取時間(分)','治工具','冶工具','作業時間(分)',
    '外注又は加工者名','単価','品質確認者',
    '項目','項　目','〇　✕','外見確認','寸法測定','幾何公差測定','ミルシートと照合','最終検査員','出荷検査','出荷承認','出荷者'
  ].map(s => s.replace(/\s+/g,'').trim()));

  const lock = td => {
    if(!td) return;
    td.setAttribute('contenteditable','false');
    td.setAttribute('aria-readonly','true');
    td.classList.add('readonly-cell');
    try{ td.blur(); }catch(e){}
  };

  tbody.querySelectorAll('td.s2, td.s9').forEach(td => {
    if(td.classList.contains('s2') || td.textContent.trim() !== '') lock(td);
  });

  tds.forEach(td => {
    if(LABEL_SET.has((td.textContent||'').replace(/\s+/g,'').trim())) lock(td);
  });

  tds.forEach(td => {
    const bg = (window.getComputedStyle(td).backgroundColor || '').replace(/\s+/g,'').toLowerCase();
    if(bg === 'rgb(217,217,217)' || bg === 'rgba(217,217,217,1)') lock(td);
  });
})();

// ========== 第2 IIFE: メイン処理 ==========
(function() {
  // ----- 日付ユーティリティ (修正版) -----
  const parseISO = iso => {
    if (!iso) return null;
    const s = String(iso).replace(/\//g, '-');
    const p = s.split('-');
    return p.length === 3 ? { y: p[0], m: p[1].padStart(2,'0'), d: p[2].padStart(2,'0') } : null;
  };

  const fmtJP = iso => { 
    const d = parseISO(iso); 
    return d ? `${d.y}年${d.m}月${d.d}日` : (iso || ''); 
  };
  
  const fmtMD = iso => { 
    const d = parseISO(iso); 
    return d ? `${Number(d.m)}/${Number(d.d)}` : (iso || ''); 
  };
  
  const splitMD = iso => { 
    const d = parseISO(iso); 
    return d ? { month: d.m, day: d.d } : { month: '', day: '' }; 
  };

  // ----- 初期JSON -----
  let headerJson = {
    "基本情報": { "発行日": "", "依頼主": "", "流動票番号": "" },
    "管理部門記入欄": {
      "会社名": "", "製品名": "", "図面番号": "", "発送日": "",
      "分納期1": "", "分納期2": "", "材質": "", "フライス": "", "購入先": "",
      "材料寸法": { "縦": "", "横": "", "高さ": "" },
      "個数": 0, "新規受注品かリピート品か": "", "製造か設計か転売か": "",
      "注文数": 0, "作成者": "",
      "関与業者": [{ "業者名": "", "役割": "" }, { "業者名": "", "役割": "" }],
      "材料価格": 0, "外注価格": 0, "工程の注意点": "", "図面問い合わせ内容": "",
      "解答": "", "販売単価": 0,
      "処理の有無": "", "いつ": "", "誰が": "", "誰に確認": "", "台待ち": 0
    }
  };

  let detailJson = {
    "工程管理記入欄": {
      "流動票番号": "", "図面番号": "", "特別購入品": ["","","",""],
      "工程管理": [{
        "作業日": "", "工程": "", "作業時間": { "開始": "", "終了": "" },
        "段取時間(分)": 0, "治工具": "", "作業時間(分)": 0,
        "外注または加工者名": "", "単価": 0, "品質確認者": ""
      }]
    },
    "調査項目": {
      "外観確認": "", "寸法判定": "", "幾何公差測定": "", "ミルシート照合": "",
      "最終検査員": "", "最終検査員の日付": "", "出荷調査": "", "出荷調査の日付": "",
      "出荷承認": "", "出荷承認の日付": "", "出荷者": "", "出荷者の日付": ""
    }
  };

  // ----- グリッド構築 -----
  const tableBody = document.querySelector('.waffle tbody');
  if (!tableBody) return;

  const COLS = "ABCDEFGHIJKLMNOPQRST".split("");
  const MAX_COLS = 20;
  const grid = [];
  const openSpans = Array(MAX_COLS).fill(null);

  Array.from(tableBody.querySelectorAll('tr')).forEach((tr, rIndex) => {
    const row = Array(MAX_COLS).fill(null);
    for (let c = 0; c < MAX_COLS; c++) {
      if (openSpans[c]) {
        row[c] = openSpans[c].cell;
        if (--openSpans[c].rowsLeft === 0) openSpans[c] = null;
      }
    }
    const cells = Array.from(tr.children).filter((el, idx) => !(idx === 0 && el.tagName === 'TH'));
    let col = 0;
    cells.forEach(td => {
      while (col < MAX_COLS && row[col] !== null) col++;
      const colspan = parseInt(td.getAttribute('colspan') || '1', 10);
      const rowspan = parseInt(td.getAttribute('rowspan') || '1', 10);
      const cellObj = { el: td, r: rIndex + 1, c: col };
      for (let c = col; c < col + colspan && c < MAX_COLS; c++) {
        row[c] = cellObj;
        if (rowspan > 1) openSpans[c] = { rowsLeft: rowspan - 1, cell: cellObj };
      }
      col += colspan;
    });
    grid.push(row);
  });

  // ----- セル操作関数 -----
  const getTd = (row, col) => {
    const ci = typeof col === 'string' ? COLS.indexOf(col.toUpperCase()) : col;
    if (row < 1 || ci === -1) return null;
    const cellObj = grid[row - 1]?.[ci];
    return cellObj?.el || null;
  };

  const lockTd = (row, col) => {
    const td = getTd(row, col);
    if (!td) return;
    td.setAttribute('contenteditable', 'false');
    td.setAttribute('aria-readonly', 'true');
    td.classList.add('readonly-cell');
  };

  const parseA1 = a1 => {
    const m = String(a1).match(/^([A-T])(\d{1,3})$/i);
    return m ? { col: m[1].toUpperCase(), row: parseInt(m[2], 10) } : null;
  };

  const lockRange = (a1Start, a1End) => {
    const s = parseA1(a1Start), e = parseA1(a1End || a1Start);
    if (!s || !e) return;
    const [cStart, cEnd] = [Math.min, Math.max].map(fn => fn(COLS.indexOf(s.col), COLS.indexOf(e.col)));
    const [rStart, rEnd] = [Math.min, Math.max].map(fn => fn(s.row, e.row));
    for (let r = rStart; r <= rEnd; r++)
      for (let c = cStart; c <= cEnd; c++) lockTd(r, COLS[c]);
  };

  // readonly範囲の適用
  [
    ["A2","A42"], ["A1","R1"], ["C2","E2"], ["F2","H2"], ["F3","H3"], ["C4","F4"],
    ["J38","T38"], ["J39","T39"], ["J40","L40"], ["J41","L41"], ["J42","L42"],
    ["O40","P40"], ["O41","P41"], ["O42","P42"]
  ].forEach(item => lockRange(item[0], item[1]));

  const setCell = (row, col, val) => {
    if (val == null) return;
    const td = getTd(row, col);
    if (!td) return;
    td.textContent = val;
    td.setAttribute('contenteditable', 'true');
    td.removeAttribute('aria-readonly');
  };

  const getCell = (row, col) => getTd(row, col)?.textContent.trim() || '';

  const addWrapClass = (row, col) => {
    const cellObj = grid[row - 1]?.[COLS.indexOf(col)];
    if (cellObj?.el) cellObj.el.classList.add('wrap-cell');
  };

  // ----- fillFromJson -----
  function fillFromJson(hJson, dJson) {
    const base = hJson?.["基本情報"] || {};
    const mgmt = hJson?.["管理部門記入欄"] || {};
    const proc = dJson?.["工程管理記入欄"] || {};
    const insp = dJson?.["調査項目"] || {};

    // 基本情報
    setCell(3, 'C', fmtJP(base["発行日"]));
    setCell(4, 'J', base["依頼主"]);
    setCell(4, 'Q', base["流動票番号"]);

    // 管理部門記入欄 - 単純マッピング
    const mgmtMap = [
      [6,'C',"会社名"], [6,'I',"製品名"], [6,'O',"図面番号"],
      [8,'E',"材質"], [8,'L',"フライス"], [8,'P',"購入先"],
      [10,'P',"個数"], [9,'R',"材料価格"], [10,'R',"外注価格"],
      [11,'R',"販売単価"], [12,'P',"注文数"], [12,'R',"作成者"],
      [16,'C',"工程の注意点"], [18,'G',"図面問い合わせ内容"]
    ];
    mgmtMap.forEach(([r, c, k]) => setCell(r, c, mgmt[k]));

    // 日付フォーマットが必要なもの
    setCell(6, 'R', fmtMD(mgmt["発送日"]));
    setCell(7, 'E', fmtMD(mgmt["分納期1"] || mgmt["分納納期１"]));
    setCell(7, 'G', fmtMD(mgmt["分納期1_2"] || ""));
    setCell(7, 'L', fmtMD(mgmt["分納期2"] || mgmt["分納納期２"]));
    setCell(7, 'N', fmtMD(mgmt["分納期2_2"] || ""));

    // 材料寸法
    if (mgmt["材料寸法"]) {
      setCell(9, 'F', mgmt["材料寸法"]["縦"]);
      setCell(9, 'J', mgmt["材料寸法"]["横"]);
      setCell(9, 'M', mgmt["材料寸法"]["高さ"] || mgmt["材料寸法"]["高"]);
    }

    // 新規/リピート、製造/設計/転売
    setCell(10, 'F', mgmt["新規受注品かリピート品か"] || mgmt["新規/リピート"]);
    setCell(10, 'L', mgmt["製造か設計か転売か"] || mgmt["製造/設計/転売"]);

    // 関与業者
    const vendors = mgmt["関与業者"] || [];
    [[11,'E','K'], [12,'E','K'], [13,'E','K'], [14,'E','K']].forEach(([r, cN, cR], i) => {
      if (vendors[i]) {
        setCell(r, cN, vendors[i]["業者名"]);
        setCell(r, cR, vendors[i]["役割"]);
      }
    });

    // 作成者にwrap-classを追加
    addWrapClass(12, 'R');

    // 工程の注意点にwrap-class
    addWrapClass(16, 'C');

    // 解答
    setCell(19, 'G', mgmt["解答"] || mgmt["回答"]);

    // 確認履歴
    setCell(20, 'E', mgmt["処理の有無"]);
    setCell(20, 'J', fmtMD(mgmt["いつ"]));
    setCell(20, 'M', mgmt["誰が"]);
    setCell(20, 'Q', mgmt["誰に確認"]); // キー名「誰に確認」

    if (mgmt["台待ち"] !== undefined) setCell(20, 'G', mgmt["台待ち"]);

    // 特別購入品 (修正版)
    const spItems = Array.isArray(proc["特別購入品"]) ? proc["特別購入品"] : [];
    const spMap = [
      { r: 21, c: 'H' },
      { r: 22, c: 'H' },
      { r: 21, c: 'O' },
      { r: 22, c: 'O' }
    ];

    spItems.forEach((item, idx) => {
      if (idx < spMap.length) {
        setCell(spMap[idx].r, spMap[idx].c, item);
      }
    });

    // 工程管理
    const jobs = Array.isArray(proc["工程管理"]) ? proc["工程管理"] : [];
    const JOB_START = 24, JOB_END = 35;
    const JOB_COLS = ['C','D','E','H','K','M','O','Q','R','S'];

    jobs.forEach((job, i) => {
      const row = JOB_START + i;
      if (row > JOB_END) return;
      const md = splitMD(job["作業日"]);
      const time = job["作業時間"];
      let workTime = "";
      if (time) {
        if (time["開始"] && time["終了"]) {
          workTime = `${time["開始"]}～${time["終了"]}`;
        } else {
          // どちらか片方だけ、あるいは自由記述の場合
          workTime = (time["開始"] || "") + (time["終了"] || "");
        }
      }
      const vals = [
        md.month, md.day, job["工程"], workTime,
        job["段取時間(分)"], job["治工具"], job["作業時間(分)"],
        job["外注または加工者名"] || job["外注又は加工者名"],
        job["単価"], job["品質確認者"]
      ];
      JOB_COLS.forEach((col, j) => setCell(row, col, vals[j]));
    });

    // 調査項目
    const inspG = [
      [39, ["外観確認","外見確認"]], [40, ["寸法判定","寸法測定"]],
      [41, ["幾何公差測定"]], [42, ["ミルシート照合","ミルシートと照合"]]
    ];
    inspG.forEach(([r, keys]) => setCell(r, 'G', keys.map(k => insp[k]).find(v => v)));

    // 検査員・出荷情報
    const inspDate = [
      [41,'M',"最終検査員の日付"], [41,'Q',"出荷調査の日付"],
      [41,'R',"出荷承認の日付"], [41,'S',"出荷者の日付"]
    ];
    inspDate.forEach(([r, c, k]) => setCell(r, c, fmtMD(insp[k])));

    const inspName = [
      [42,'M',"最終検査員"], [42,'Q',"出荷調査"], [42,'R',"出荷承認"], [42,'S',"出荷者"]
    ];
    inspName.forEach(([r, c, k]) => setCell(r, c, insp[k]));
  }

  // ----- rebuildJsonFromTable -----
  function rebuildJsonFromTable() {
    const newHeader = JSON.parse(JSON.stringify(headerJson));
    const newDetail = JSON.parse(JSON.stringify(detailJson));

    // 基本情報
    newHeader["基本情報"] = newHeader["基本情報"] || {};
    newHeader["基本情報"]["発行日"] = getCell(3, 'C');
    newHeader["基本情報"]["依頼主"] = getCell(4, 'J');
    newHeader["基本情報"]["流動票番号"] = getCell(4, 'Q');

    // 管理部門記入欄
    const mgmt = newHeader["管理部門記入欄"] || {};
    
    const mgmtSimple = [
      ['会社名',6,'C'], ['製品名',6,'I'], ['図面番号',6,'O'], ['発送日',6,'R'],
      ['材質',8,'E'], ['フライス',8,'L'], ['購入先',8,'P'],
      ['外注価格',10,'R'], ['注文数',12,'P'], ['販売単価',11,'R'], ['作成者',12,'R'],
      ['工程の注意点',16,'C'], ['図面問い合わせ内容',18,'G'], ['解答',19,'G']
    ];
    mgmtSimple.forEach(([k, r, c]) => mgmt[k] = getCell(r, c));

    // 分納期
    const dn1L = getCell(7, 'E'), dn1R = getCell(7, 'G');
    const dn2L = getCell(7, 'L'), dn2R = getCell(7, 'N');
    Object.assign(mgmt, {
      "分納期1": dn1L, "分納期1_2": dn1R,
      "分納期2": dn2L, "分納期2_2": dn2R
    });

    // 材料寸法
    mgmt["材料寸法"] = { "縦": getCell(9,'F'), "横": getCell(9,'J'), "高さ": getCell(9,'M') };
    mgmt["個数"] = getCell(10, 'P');
    mgmt["材料価格"] = getCell(9, 'R');

    // 新規/リピート
    const nrVal = getCell(10, 'F'), msVal = getCell(10, 'L');
    mgmt["新規受注品かリピート品か"] = nrVal;
    mgmt["製造か設計か転売か"] = msVal;

    // 関与業者
    mgmt["関与業者"] = [11,12,13,14].map(r => ({ "業者名": getCell(r,'E'), "役割": getCell(r,'K') }));

   // 確認履歴 (フラット化対応)
    mgmt["処理の有無"] = getCell(20, 'E');
    mgmt["いつ"] = getCell(20, 'J');
    mgmt["誰が"] = getCell(20, 'M');
    mgmt["誰に確認"] = getCell(20, 'Q');
    mgmt["台待ち"] = getCell(20, 'G');
    
    // 不要な配列データがあれば削除
    delete mgmt["確認履歴"];
    
    // 工程管理記入欄
    const proc = newDetail["工程管理記入欄"] || {};
    proc["特別購入品"] = [
      getCell(21, 'H'),
      getCell(22, 'H'),
      getCell(21, 'O'),
      getCell(22, 'O')
    ];

    const rows = [];
    const JOB_COLS = ['C','D','E','H','K','M','O','Q','R','S'];

    // 現在の日付情報を取得
    const today = new Date();
    const thisYear = today.getFullYear();
    const thisMonth = today.getMonth() + 1; // 1月=1, 12月=12

    for (let r = 24; r <= 35; r++) {
      const vals = JOB_COLS.map(c => getCell(r, c));
      const [month, day, kou, time, setup, jig, workm, worker, price, qc] = vals;
      if (!vals.some(v => v)) continue;

      // --- 年の自動判定ロジック ---
      let targetYear = thisYear;
      const mVal = parseInt(month, 10);
      
      // もし「現在は1月〜3月」かつ「入力された月が10月〜12月」なら、去年のこととみなす
      if (thisMonth <= 3 && mVal >= 10) {
        targetYear = thisYear - 1;
      }
      // --------------------------

      // 月と日を2桁(0埋め)に整形
      const mm = month ? month.toString().padStart(2, '0') : '';
      const dd = day ? day.toString().padStart(2, '0') : '';

      // 作業時間の分割処理を丁寧に行う
      let tStart = time, tEnd = "";
      if (time && time.includes('～')) {
        const parts = time.split('～');
        tStart = parts[0];
        tEnd = parts[1] || "";
      }

      rows.push({
        "作業日": (month && day) ? `${targetYear}-${mm}-${dd}` : "",
        "工程": kou,
        "作業時間": { "開始": tStart, "終了": tEnd }, // 修正後の変数を使用
        "段取時間(分)": setup, "治工具": jig, "作業時間(分)": workm,
        "外注または加工者名": worker, "単価": price, "品質確認者": qc
      });
    }
    proc["工程管理"] = rows;
    newDetail["工程管理記入欄"] = proc;

    // 調査項目
    const insp = newDetail["調査項目"] || {};
    const inspMap = [
      ["外観確認",39,'G'], ["寸法判定",40,'G'], ["幾何公差測定",41,'G'], ["ミルシート照合",42,'G'],
      ["最終検査員の日付",41,'M'], ["最終検査員",42,'M'],
      ["出荷調査の日付",41,'Q'], ["出荷調査",42,'Q'],
      ["出荷承認の日付",41,'R'], ["出荷承認",42,'R'],
      ["出荷者の日付",41,'S'], ["出荷者",42,'S']
    ];
    inspMap.forEach(([k, r, c]) => insp[k] = getCell(r, c));
    newDetail["調査項目"] = insp;

    return { headerJson: newHeader, detailJson: newDetail };
  }

  // ----- JSON抽出 (強化版: エラー無視・ゴミデータ無視) -----
  function extractJsonObjects(rawText) {
    // Markdown記法などを除去
    const text = rawText.replace(/```json/gi, '').replace(/```/g, '').trim();
    const results = [];
    let buf = '', depth = 0, inString = false, prev = '';

    for (const ch of text) {
      // 文字列の中にある "{" などを無視するための判定
      if (ch === '"' && prev !== '\\') inString = !inString;

      // depthが0（{の外側）の時の文字は無視するが、{ が来た瞬間だけ depthを増やす
      if (!inString) {
        if (ch === '{') {
          if (depth === 0) buf = ''; // ゴミデータをリセット
          depth++;
        }
      }

      // depthが1以上（ { の中 ）の時だけ記録する
      if (depth > 0) {
         buf += ch;
      }

      if (!inString) {
        if (ch === '}') {
          depth--;
          // オブジェクトの終了
          if (depth === 0) {
            try {
              // ここでパースに失敗しても無視する
              results.push(JSON.parse(buf));
            } catch (e) {
              console.log("無視された不正なJSONブロック:", buf);
            }
            buf = '';
          }
        }
      }
      prev = ch;
    }
    return results;
  }

  // ============================================================
  //  イベントハンドラ・自動保存・初期読み込み (すべて統合版)
  // ============================================================

  const applyBtn = document.getElementById('apply-json-btn');
  const jsonInput = document.getElementById('json-input');
  const saveBtn = document.getElementById('save-btn');
  const printBtn = document.getElementById('print-btn');
  const statusSpan = document.getElementById('save-status');

  let autoSaveTimer; // 自動保存のタイマー

  // 保存中かどうかを判定するフラグ
  let isSavingProcess = false;

  // ■ 共通の保存処理関数
  const performSave = (isAuto) => {
    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
      console.log("GAS環境ではないため保存スキップ");
      return;
    }

    const content = jsonInput.value;
    
    // 保存中フラグをON
    isSavingProcess = true;

    // 保存中表示
    if (statusSpan) statusSpan.textContent = isAuto ? "自動保存中..." : "保存中...";
    if (saveBtn) saveBtn.disabled = true;

    google.script.run
      .withSuccessHandler(function(msg) {
        // 保存中フラグをOFF
        isSavingProcess = false;

        // 成功時
        const time = new Date().toLocaleTimeString();
        if (statusSpan) {
          statusSpan.textContent = "保存完了 (" + time + ")";
          statusSpan.style.color = "green";
        }
        if (saveBtn) saveBtn.disabled = false;
      })
      .withFailureHandler(function(error) {
        // 保存中フラグをOFF
        isSavingProcess = false;

        // 失敗時
        if (statusSpan) {
          statusSpan.textContent = "保存失敗";
          statusSpan.style.color = "red";
        }
        if (!isAuto) alert('保存エラー: ' + error); // エラー時は念のため出すか、ここも消してステータスのみにするかはお好みで
        if (saveBtn) saveBtn.disabled = false;
      })
      .saveDataToDrive(content);
  };

  // ★ 画面を閉じたり更新したりする際の警告処理を追加
  window.addEventListener('beforeunload', function(e) {
    if (isSavingProcess) {
      // 保存中の場合、ブラウザ標準の警告ダイアログを出す設定
      e.preventDefault();
      e.returnValue = ''; // Chrome等の仕様で空文字を設定
    }
  });

  // ■ 1. テーブル変更時の処理（JSON更新 ＋ 自動保存予約）
  if (tableBody && jsonInput) {
    tableBody.addEventListener('input', () => {
      // (1) JSONを更新
      const rebuilt = rebuildJsonFromTable();
      headerJson = rebuilt.headerJson;
      detailJson = rebuilt.detailJson;
      jsonInput.value = JSON.stringify(headerJson, null, 2) + "\n" + JSON.stringify(detailJson, null, 2);

      // (2) 自動保存の予約（3秒後に実行）
      if (statusSpan) {
        statusSpan.textContent = "編集を検知... (3秒後に保存)";
        statusSpan.style.color = "#666";
      }
      
      clearTimeout(autoSaveTimer); 
      autoSaveTimer = setTimeout(() => {
        performSave(true); // 自動保存モード
      }, 3000); 
    });
  }

  // ■ 2. 「ドライブに保存」ボタン（手動保存）
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      clearTimeout(autoSaveTimer); 
      performSave(false); // 手動モード
    });
  }

  // ■ 3. 「印刷」ボタン
  if (printBtn) {
    printBtn.addEventListener('click', () => {
      window.print();
    });
  }

 // ■ 4. 「情報を反映」ボタン
  if (applyBtn && jsonInput) {
    applyBtn.addEventListener('click', () => {
      const text = jsonInput.value.trim();
      if (!text) return;
      
      try {
        const objects = extractJsonObjects(text); // 強化版関数を使用
        
        if (objects.length === 0) return;

        objects.forEach(obj => {
          if (obj.headerJson || obj.detailJson) {
            if (obj.headerJson) headerJson = obj.headerJson;
            if (obj.detailJson) detailJson = obj.detailJson;
            return;
          }
          // return を削除し、同じオブジェクトから両方の情報を取得できるようにする
          if (obj["基本情報"] || obj["管理部門記入欄"]) { headerJson = obj; }
          if (obj["工程管理記入欄"] || obj["調査項目"]) { detailJson = obj; }
        });

        fillFromJson(headerJson, detailJson);
        
        // 反映後、自動保存を走らせる
        const event = new Event('input', { bubbles: true });
        tableBody.dispatchEvent(event);

      } catch (e) {
        // アラートは出さず、裏側でログだけ残す
        console.warn('反映処理エラー（無視しました）:', e);
      }
    });
  }

  // ■ 5. ★ここが復活させた初期読み込み処理です★
  window.addEventListener('load', function() {
    if (typeof google === 'undefined' || typeof google.script === 'undefined') return;

    if (statusSpan) statusSpan.textContent = "データを読み込み中...";

    google.script.run
      .withSuccessHandler(function(data) {
        if (jsonInput) {
          jsonInput.value = data;
          // データが入ったら自動で「情報を反映」ボタンを押す
          if (applyBtn) {
             setTimeout(() => {
               applyBtn.click();
               if(statusSpan) statusSpan.textContent = ""; // 読み込み完了後はクリア
             }, 100);
          }
        }
      })
      .withFailureHandler(function(error) {
        alert('ドライブからの読み込みに失敗しました: ' + error);
      })
      .getDataFromDrive();
  });

  // ■ 6. 検索機能のイベントリスナー
  const searchBtn = document.getElementById('search-btn');
  const searchInput = document.getElementById('search-keyword');
  const searchStatus = document.getElementById('search-status'); // HTMLに追加したspan IDと合わせる

  if (searchBtn && searchInput) {
    searchBtn.addEventListener('click', function() {
      const keyword = searchInput.value.trim();
      if (!keyword) {
        alert("流動票番号を入力してください");
        return;
      }

      if (typeof google === 'undefined' || typeof google.script === 'undefined') {
        alert("GAS環境ではないため検索できません");
        return;
      }

      // UIの状態更新
      searchBtn.disabled = true;
      if (searchStatus) {
        searchStatus.textContent = "ドライブ内を検索中...";
        searchStatus.style.color = "blue";
      }

      // GASの検索関数を呼び出し
      google.script.run
        .withSuccessHandler(function(jsonResult) {
          searchBtn.disabled = false;
          if (jsonResult) {
            // 見つかったJSONをテキストエリアに入れる
            if (jsonInput) {
              jsonInput.value = jsonResult;
              
              // 「情報を反映」ボタンを自動クリックしてテーブルに展開
              if (applyBtn) {
                applyBtn.click();
              }
            }
            if (searchStatus) {
              searchStatus.textContent = "検索完了: データを反映しました";
              searchStatus.style.color = "green";
            }
          } else {
            // 見つからなかった場合
            if (searchStatus) {
              searchStatus.textContent = "該当するデータが見つかりませんでした";
              searchStatus.style.color = "red";
            }
            alert("流動票番号: " + keyword + " に一致するデータが見つかりませんでした。");
          }
        })
        .withFailureHandler(function(error) {
          searchBtn.disabled = false;
          if (searchStatus) {
            searchStatus.textContent = "検索エラー";
            searchStatus.style.color = "red";
          }
          alert('検索処理中にエラーが発生しました: ' + error);
        })
        .searchByNumber(keyword); // GAS側の関数名
    });
  }

})(); // ← メイン処理の閉じカッコ
</script>
